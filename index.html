<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MS Digital Brochure</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, sans-serif;
      background: linear-gradient(135deg,#ff6b6b 0%,#a50034 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
      color:#111; user-select:none;
    }
    .wrap{width:min(100%, 900px)}

    .flipbook{
      position:relative; width:100%; aspect-ratio: 1.414;
      background:#fff; border-radius:8px; box-shadow:0 20px 40px rgba(0,0,0,.3); overflow:hidden;
      perspective: 1500px; transform-style: preserve-3d; margin:0 auto;
      -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-user-drag:none;
    }

    .sheet{ position:absolute; inset:0; }

    .page{
      position:absolute; top:0; bottom:0; width:50%; overflow:hidden; background:#fff;
      background-position:center; background-size:cover; background-repeat:no-repeat;
      pointer-events:none; backface-visibility:hidden; transform-style:preserve-3d;
      will-change: transform; contain: layout paint;
    }
    .page.left { 
      left:0; border-right:1px solid rgba(0,0,0,.06); 
      transform-origin: right center;
    }
    .page.right{ 
      right:0; 
      transform-origin: left center;
    }
    .page.blank{ background:#fff !important; }

    /* 중앙 스파인 */
    .flipbook::before{
      content:''; position:absolute; top:0; bottom:0; left:50%; width:2px; transform:translateX(-1px);
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,0) 40%, rgba(0,0,0,.12));
      opacity:.25; pointer-events:none;
    }

    /* 페이지 뒤집기 애니메이션 */
    .page.flipping {
      transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 1000;
    }

    .page.flipping::after {
      content:''; position:absolute; inset:0; pointer-events:none;
      background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,.2) 50%, rgba(0,0,0,0));
      transition: opacity 0.7s ease;
    }

    .page.flip-right {
      transform: rotateY(-180deg);
    }

    .page.flip-left {
      transform: rotateY(180deg);
    }

    .controls{ display:flex; justify-content:center; align-items:center; gap:12px; margin-top:20px }
    .nav-btn{
      background:#fff; color:#e60012; border:none; padding:12px 20px; border-radius:999px; cursor:pointer;
      font-size:15px; font-weight:700; transition: transform .15s ease, box-shadow .15s ease; box-shadow:0 6px 18px rgba(230,0,18,.35);
      user-select:none; -webkit-user-select:none;
    }
    .nav-btn:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(230,0,18,.45); }
    .nav-btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; box-shadow:none }

    .loading{ position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background: rgba(255,255,255,.95); z-index:2000; gap:10px }
    .spinner{ width:30px; height:30px; border:3px solid #f3f3f3; border-top:3px solid #e60012; border-radius:50%; animation:spin .8s linear infinite }
    @keyframes spin{ to{ transform: rotate(360deg) } }

    @media (max-width: 768px){ .wrap{width:90vw} .nav-btn{ padding:10px 16px; font-size:14px } }
    @media (prefers-reduced-motion: reduce){ .page{ transition:none !important } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="flipbook" id="flipbook" aria-label="Flipbook">
      <div class="loading" id="loading"><div class="spinner"></div><div>Loading pages…</div></div>
    </div>

    <div class="controls" aria-label="Pagination controls">
      <button class="nav-btn" id="prevBtn">← Previous</button>
      <button class="nav-btn" id="nextBtn">Next →</button>
    </div>
  </div>

  <script>
    const CONFIG = {
      imagePrefix: 'Pg',
      imageExtensions: ['jpg','jpeg','png','webp'],
      maxPagesToCheck: 100,
      loadingTimeout: 5000,
      preloadAhead: 2,
      animationDuration: 700
    };

    let totalImages = 0, currentSpread = 0, totalSpreads = 0, isAnimating = false;
    const spreads = []; // Each spread shows 2 pages side by side
    const preloaded = new Set();

    const $ = s => document.querySelector(s);
    const flipbook = $('#flipbook'), loading = $('#loading');
    const prevBtn = $('#prevBtn'), nextBtn = $('#nextBtn');

    prevBtn.addEventListener('click', previousSpread);
    nextBtn.addEventListener('click', nextSpread);

    document.addEventListener('keydown', e=>{
      if(['ArrowLeft','ArrowUp'].includes(e.key)){ e.preventDefault(); previousSpread(); }
      if(['ArrowRight','ArrowDown'].includes(e.key)){ e.preventDefault(); nextSpread(); }
    });

    flipbook.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('dragstart', e=>e.preventDefault());

    async function init(){
      const detected = await detectPages();
      if(detected.length === 0){
        loading.innerHTML = `<div style="color:#e74c3c;text-align:center"><strong>No pages found</strong><br>Place images in the same folder as this HTML file.<br>Name them: <code>${CONFIG.imagePrefix}1.jpg</code>, <code>${CONFIG.imagePrefix}2.jpg</code>, etc.<br><small>Supported formats: ${CONFIG.imageExtensions.join(', ')}</small></div>`;
        updateControls(); return;
      }
      totalImages = detected.length;

      // Create spreads (2 pages each, except first page alone)
      if(detected.length > 0) {
        // First spread: blank + cover page
        spreads.push({ leftPage: null, rightPage: detected[0] });
        
        // Remaining spreads: pairs of pages
        for(let i = 1; i < detected.length; i += 2) {
          const leftPage = detected[i] || null;
          const rightPage = detected[i + 1] || null;
          spreads.push({ leftPage, rightPage });
        }
      }

      totalSpreads = spreads.length;
      createAllSpreads();
      showSpread(0);

      loading.style.display = 'none';
      updateControls();
      preloadAround(currentSpread);
    }

    function createAllSpreads() {
      spreads.forEach((spread, index) => {
        const spreadEl = document.createElement('div');
        spreadEl.className = 'sheet';
        spreadEl.style.zIndex = 1000 - index;
        
        // Left page
        const leftPage = document.createElement('div');
        leftPage.className = 'page left';
        if(spread.leftPage) {
          leftPage.style.backgroundImage = `url('${spread.leftPage.path}')`;
        } else {
          leftPage.classList.add('blank');
        }
        
        // Right page  
        const rightPage = document.createElement('div');
        rightPage.className = 'page right';
        if(spread.rightPage) {
          rightPage.style.backgroundImage = `url('${spread.rightPage.path}')`;
        } else {
          rightPage.classList.add('blank');
        }
        
        spreadEl.appendChild(leftPage);
        spreadEl.appendChild(rightPage);
        flipbook.appendChild(spreadEl);
        
        spread.element = spreadEl;
        spread.leftPageEl = leftPage;
        spread.rightPageEl = rightPage;
      });
    }

    function showSpread(index) {
      spreads.forEach((spread, i) => {
        spread.element.style.display = (i === index) ? 'block' : 'none';
        resetPageStyles(spread);
      });
      currentSpread = index;
    }

    function resetPageStyles(spread) {
      [spread.leftPageEl, spread.rightPageEl].forEach(page => {
        page.classList.remove('flipping', 'flip-right', 'flip-left');
        page.style.transform = '';
      });
    }

    function nextSpread() {
      if(isAnimating || currentSpread >= totalSpreads - 1) return;
      
      isAnimating = true;
      updateControls();
      
      const currentSpreadEl = spreads[currentSpread];
      const nextSpreadEl = spreads[currentSpread + 1];
      
      // Show both current and next spread
      currentSpreadEl.element.style.display = 'block';
      nextSpreadEl.element.style.display = 'block';
      
      // The right page of current spread flips to reveal next spread
      const rightPage = currentSpreadEl.rightPageEl;
      
      rightPage.classList.add('flipping');
      requestAnimationFrame(() => {
        rightPage.classList.add('flip-right');
      });
      
      setTimeout(() => {
        showSpread(currentSpread + 1);
        isAnimating = false;
        updateControls();
        preloadAround(currentSpread);
      }, CONFIG.animationDuration);
    }

    function previousSpread() {
      if(isAnimating || currentSpread <= 0) return;
      
      isAnimating = true;
      updateControls();
      
      const currentSpreadEl = spreads[currentSpread];
      const prevSpreadEl = spreads[currentSpread - 1];
      
      // Show both spreads
      currentSpreadEl.element.style.display = 'block';
      prevSpreadEl.element.style.display = 'block';
      
      // The left page of current spread flips back to reveal previous spread
      const leftPage = currentSpreadEl.leftPageEl;
      
      leftPage.classList.add('flipping');
      requestAnimationFrame(() => {
        leftPage.classList.add('flip-left');
      });
      
      setTimeout(() => {
        showSpread(currentSpread - 1);
        isAnimating = false;
        updateControls();
        preloadAround(currentSpread);
      }, CONFIG.animationDuration);
    }

    function updateControls(){
      prevBtn.disabled = (currentSpread <= 0) || isAnimating;
      nextBtn.disabled = (currentSpread >= totalSpreads - 1) || isAnimating;
    }

    function preloadAround(index){
      const paths = [];
      for(let d = -CONFIG.preloadAhead; d <= CONFIG.preloadAhead; d++){
        const si = index + d;
        if(si < 0 || si >= spreads.length) continue;
        const spread = spreads[si];
        if(spread.leftPage) paths.push(spread.leftPage.path);
        if(spread.rightPage) paths.push(spread.rightPage.path);
      }
      paths.forEach(path => {
        if(preloaded.has(path)) return;
        const img = new Image();
        img.decoding = 'async'; 
        img.loading = 'eager'; 
        img.src = path;
        preloaded.add(path);
      });
    }

    async function detectPages(){
      const found = [];
      for(let i = 1; i <= CONFIG.maxPagesToCheck; i++){
        let ok = false, pickedPath = '';
        for(const ext of CONFIG.imageExtensions){
          const src = `${CONFIG.imagePrefix}${i}.${ext}`;
          const exists = await checkImage(src);
          if(exists){ ok = true; pickedPath = src; break; }
        }
        if(ok){ found.push({number: i, path: pickedPath}); }
        else if(found.length > 0){ break; }
      }
      return found;
    }

    function checkImage(src){
      return new Promise((resolve) => {
        const img = new Image();
        let done = false;
        const timeout = setTimeout(() => { 
          if(!done){ done = true; resolve(false); } 
        }, CONFIG.loadingTimeout);
        
        img.onload = () => { 
          if(!done){ done = true; clearTimeout(timeout); resolve(true); } 
        };
        img.onerror = () => { 
          if(!done){ done = true; clearTimeout(timeout); resolve(false); } 
        };
        img.src = src + `?v=${Date.now()}`;
      });
    }

    init();
  </script>
</body>
</html>
